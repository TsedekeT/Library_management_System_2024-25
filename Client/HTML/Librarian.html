<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Librarian Dashboard</title>
  <link rel="stylesheet" href="../CSS/Librarian.css">
  <link rel="stylesheet" href="../CSS/home.css">
  <link rel="stylesheet" href="../bootstrap/css/bootstrap.css">
</head>
<body>
  <header>
    <nav class="navbar">
      <div class="container">
        <a href="#home" class="logo"><img src="../img/EduShelf_  Managing Books with Ease.jpg" alt="EduShelf"><h1>EduShelf</h1></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          â˜°
        </button>
        <ul class="nav-links">
          <li><a class="btn">HOME</a></li>
          <li><button class="btn btn-danger" id="LogOut">LogOut</button></li>
        </ul>
      </div>
    </nav>
  </header>

  <main>
    <section class="book-grid">
      <div class="container">
        <h2 class="text-center pt-5">Available Books</h2>
        <div id="bookDisplay" class="grid"></div>
      </div>
    </section>
    <div class="w-100 d-flex justify-content-center">
      <button class="w-75 btn bg-primary-subtle btn-block" type="button" data-bs-toggle="modal" data-bs-target="#addBook">Add Books</button>
    </div>

    <section class="" id="approvals-section">
      <h2 class="text-center py-5">Pending User Approvals</h2>
      <div id="errorContainer" class="bg-gradient-danger text-center"></div>
      <div class="px-4 d-flex flex-column " id="pending-users"></div>
    </section>
  </main>

  <!-- Modal -->
  <div class="modal fade" id="addBook" tabindex="-1" aria-hidden="true" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-center" id="exampleModalLabel">Create A New Book</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addBookForm" enctype="multipart/form-data" class="form">
            <div class="form-group">
              <label for="name">Autor Name</label>
              <input type="text" required class="form-control" id="name" name="name" aria-describedby="emailHelp" placeholder="Enter the name of the Author">
            </div>
            <div class="form-group">
              <label for="name">category</label>
              <select class="custom-select" id="category">
                <option selected>Open this select menu</option>
                <option value="mens">Life Style</option>
                <option value="womens">Biography</option>
                <option value="kids">Children & Youth</option>
              </select>
            </div>
            <div class="form-group">
              <label for="bookName">Book Name</label>
              <input type="text" class="form-control" name="bookName" id="bookName" placeholder="Enter book name" required>
            </div>
            <div class="form-group">
              <label for="exampleFormControlTextarea1">Description</label>
              <textarea class="form-control" name="description" id="description" rows="3"></textarea>
            </div>
            <div class="form-group">
              <div class="">
                <div class="input-group mt-3">
                  <div class="custom-file">
                    <input id="Image" type="file" name="Image" class="custom-file-input" accept="image/*" required>
                    <label class="custom-file-label" for="Image">Select Image</label>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <div class="">
                <div class="input-group mt-3">
                  <div class="custom-file">
                    <input id="book" type="file" name="book" class="custom-file-input" accept=".pdf, .docx, .doc" required>
                    <label class="custom-file-label" for="book">Select Book</label>
                  </div>
                </div>
              </div>
            </div>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn bg-secondary-subtle" data-bs-dismiss="modal">Close</button>
          <button type="submit" value="submit" class="btn bg-primary-subtle">Submit</button>
        </div>
      </form>
      </div>
    </div>
  </div>
  <!-- Modal -->
  <div class="modal fade" id="editBook" tabindex="-1" aria-hidden="true" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-center" id="exampleModalLabel">Update</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="updateForm" enctype="multipart/form-data" class="form">
            <div class="form-group">
              <label for="name">Autor Name</label>
              <input type="text" class="form-control" id="nameEdit" name="nameEdit" aria-describedby="emailHelp" placeholder="Enter the name of the Author">
            </div>
            <div class="form-group">
              <label for="name">category</label>
              <select class="custom-select" id="categoryEdit">
                <option selected>Open this select menu</option>
                <option value="mens">Mens</option>
                <option value="womens">Womens</option>
                <option value="kids">Children</option>
              </select>
            </div>
            <div class="form-group">
              <label for="price">Price</label>
              <input type="text" class="form-control" name="bookNameEdit" id="bookNameEdit" placeholder="Enter Price">
            </div>
            <div class="form-group">
              <label for="exampleFormControlTextarea1">Description</label>
              <textarea class="form-control" name="descriptionEdit" id="descriptionEdit" rows="3"></textarea>
            </div>
            <div class="form-group">
              <div class="">
                <div class="input-group mt-3">
                  <div class="custom-file">
                    <input id="ImageEdit" type="file" name="ImageEdit" class="custom-file-input" accept="image/*">
                    <label class="custom-file-label" for="Image">Select Image</label>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <div class="">
                <div class="input-group mt-3">
                  <div class="custom-file">
                    <input id="bookEdit" type="file" name="bookEdit" class="custom-file-input" accept=".pdf, .docx, .doc">
                    <label class="custom-file-label" for="book">Select Book</label>
                  </div>
                </div>
              </div>
            </div>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn bg-secondary-subtle" data-bs-dismiss="modal">Close</button>
          <button type="submit" value="submit" class="btn bg-primary-subtle">Submit</button>
        </div>
      </form>
      </div>
    </div>
  </div>
</body>

  <footer>
    <div class="container">
      <p>&copy; 2025 Library Management System. All rights reserved.</p>
    </div>
  </footer>

  <script src="./script/Librarian.js"></script> 
  <script src="../bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="../bootstrap/js/bsFileInput.min.js"></script>
  
  <script>
    bsCustomFileInput.init()

    const myModal = new bootstrap.Modal(document.getElementById('addBook'));
    const updateModel = new bootstrap.Modal(document.getElementById('editBook'));
    const BASE_URL = "http://localhost:7000/"
    const pendingUsers = document.getElementById("pending-users");
    const errorContainer = document.getElementById('errorContainer');
    const LogOutBtn = document.getElementById("LogOut");
    const AddBookFrom = document.getElementById("addBookForm")
    const BookDisplayLocation = document.getElementById("bookDisplay")

    AddBookFrom.addEventListener('submit', handelBookSubmit)
    LogOutBtn.addEventListener("click", () => {
      localStorage.removeItem("Token")
      window.location.href = "./home.html"
    })

    async function handelDelete(productId) {
      await fetch(BASE_URL + `products/${productId}/`, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${localStorage.getItem("Token")}`,
        },
      })
      .then(res => {
        if(res.status !== 200) {
          switch (res.status) {
            case 401:
              displayError("It seens your session has ended. Log again!")
              setTimeout(() => window.location.href = "./home.html", 1000)
              break;
            case 403:
              displayError("You Don't have permission to do these action")
              break
            default:
              displayError("There is un expected error!")
              break;
          }
        } else {
          const removableElement = document.getElementById(`product_${productId}`)
          removableElement.remove()
        }
      })
    }

    function listBooks() {
      BookDisplayLocation.innerHTML = ""
      fetch(BASE_URL + "products/", {
        method: "GET",
        headers: {
          "Authorization": `Bearer ${localStorage.getItem("Token")}`,
        }
        
      })
      .then(async res => {
        if(res.status === 200) {
          const jsonData = await res.json()
          jsonData.forEach((product)=>{
            let tempElement = `
            <div id="product_${product._id}" class="book-item">
              <img class="" src="${BASE_URL + "static/" + product.image}" alt="Book Title 6">
              <h3>${product.bookName}</h3>
              <p>by ${product.name}</p>
              <button class="btn bg-success" onclick="handelUpdate('${product._id}')">Edit</button>
              <button class="btn bg-danger" onclick="handelDelete('${product._id}')">Delete</button>
            </div>
            `
            BookDisplayLocation.innerHTML += tempElement
          })
        }
        if(BookDisplayLocation.innerHTML.length === 0) {
          BookDisplayLocation.innerHTML =  `
            <div class="alert alert-success p-5">
              <h3 class="text-center"> There is No Book avaliable right now</h3>
            </div>`
        }
      })
    }

    async function handelUpdate(productId) {
      updateModel.show()
      const updateForm = document.getElementById("updateForm")
      updateForm.addEventListener('submit', (e) => {
        e.preventDefault()
        let BookFormData = new FormData()
        const name = document.getElementById('nameEdit')
        const price = document.getElementById('bookNameEdit')
        const description = document.getElementById('descriptionEdit')
        const category = document.getElementById('categoryEdit')
        const image = document.getElementById('ImageEdit').files[0]
        const book = document.getElementById('bookEdit').files[0]

        BookFormData.append("name", name.value)
        BookFormData.append("bookName", price.value)
        BookFormData.append("description", description.value)
        BookFormData.append("category", category.value)
        BookFormData.append("image", image)
        BookFormData.append("book", book)

        const options = {
            method: "PATCH",
            headers: {
            "Authorization": `Bearer ${localStorage.getItem("Token")}`,
            },
            body: BookFormData,
        }

        fetch(BASE_URL + `products/${productId}`, options)
        .then(async res => {
          if(res.status !== 200) {
            switch (res.status) {
              case 401:
                displayError("It seens your session has ended. Log again!")
                setTimeout(() => window.location.href = "./home.html", 1000)
                break;
              case 403:
                displayError("You Don't have permission to do these action")
                break
              case 201:
                break;
              default:
                displayError("There is un expected error!")
                break;
            }
          }
          console.log(await res.json())
        })
        .then(() => {
          updateModel.hide()
          updateForm.reset()
          listBooks()
        })
      })
    }

    function displayError(message) {
        const errorAlert = document.createElement('div');
        errorAlert.className = 'alert alert-danger alert-dismissible fade show';
        errorAlert.role = 'alert';
        errorAlert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        errorContainer.appendChild(errorAlert);
    }

    async function handelBookSubmit(e) {
      e.preventDefault()
      let BookFormData = new FormData()
      const name = document.getElementById('name')
      const price = document.getElementById('bookName')
      const description = document.getElementById('description')
      const category = document.getElementById('category')
      const image = document.getElementById('Image').files[0]
      const book = document.getElementById('book').files[0]

      BookFormData.append("name", name.value)
      BookFormData.append("bookName", price.value)
      BookFormData.append("description", description.value)
      BookFormData.append("category", category.value)
      BookFormData.append("image", image)
      BookFormData.append("book", book)

      const options = {
          method: "POST",
          headers: {
          "Authorization": `Bearer ${localStorage.getItem("Token")}`,
          },
          body: BookFormData,
      }

      fetch(BASE_URL + "products/create", options)
      .then(async res => {
        if(res.status !== 200) {
          switch (res.status) {
            case 401:
              displayError("It seens your session has ended. Log again!")
              setTimeout(() => window.location.href = "./home.html", 1000)
              break;
            case 403:
              displayError("You Don't have permission to do these action")
              break
            case 201:
              break;
            default:
              displayError("There is un expected error!")
              break;
          }
        }
        console.log(await res.json())
      })
      .then(() => {
        myModal.hide()
        AddBookFrom.reset()
        listBooks()
      })
    }
    async function approveUser(userId, isApproved) {
      const data = new FormData()
      data.append("userId", userId)
      data.append("isApproved", isApproved ? "true" : "false")
      const toSend = Object.fromEntries(data)

      const options = {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${localStorage.getItem('Token')}`,
        },
        body: JSON.stringify(toSend)
      }
      fetch(BASE_URL + 'auth/approve/', options)
      .then(async res => {
        if(res.status !== 200) {
          switch (res.status) {
            case 401:
              displayError("It seens your session has ended. Log again!")
              setTimeout(() => window.location.href = "./home.html", 1000)
              break;
            case 403:
              displayError("You Don't have permission to do these action")
              break
            default:
              displayError("There is un expected error!")
              break;
          }
        } else {
          const removableElement = document.getElementById(`user_${userId}`)
          removableElement.remove()
          collectUsers()
        }
      })
      .catch(err => console.log(err))
    }

    async function collectUsers() {
      const options = {
        method: "GET",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${localStorage.getItem("Token")}`,
        },
      }
      fetch(BASE_URL + 'auth/filter-by-approval/?isApproved=false', options)
      .then(async res => await res.json())
      .then(res => {
        res.forEach((user) => {
          if(!user.isApproved && !user.isReject) {
            pendingUsers.innerHTML = "";
            const userHTML = `
              <div class="alert alert-warning alert-dismissible fade show" id="user_${user._id}" role="alert">
                <strong>Name: ${user.name}</strong>
                <p>Email: ${user.email}</p>
                <p>Role: ${user.role.join(', ')}</p>
                <button type="button" class="btn btn-primary" onclick="approveUser('${user._id}', ${true})">Approve</button>
                <button type="button" class="btn btn-danger float-end" onclick="approveUser('${user._id}', ${false})">Reject</button>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
              
            `;
            pendingUsers.innerHTML += userHTML;
          }
        });
        if(pendingUsers.innerHTML.length === 0) {
          pendingUsers.innerHTML += `
            <div class="alert alert-success p-5">
              <h3 class="text-center"> There Are No requestes at these times</h3>
            </div>
          `
        }
      })
      .catch(err => console.log(err))
    }

    document.addEventListener("DOMContentLoaded", 
      collectUsers(),
      listBooks()
    )
  </script>
</body>
</html>